// ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ libraries ‡πÅ‡∏•‡∏∞ components ‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô
import React, { useEffect, useState } from "react"
import { FlatList, RefreshControl, Image, ActivityIndicator, TouchableOpacity, SafeAreaView } from "react-native"
import { View, Text } from "@/components/Themed"
import ProductCard from "@/components/ProductCard"
import HorizontalCard from "@/components/HorizontalCard"
import SearchInput from "@/components/SearchInput"
import { useAuth } from "@/providers/AuthProvider"
import { supabase } from "@/utils/supabase"
import { formatDistanceToNow, parseISO } from 'date-fns'
import { th } from 'date-fns/locale'
import { toZonedTime } from 'date-fns-tz'
import { useTheme } from '@/providers/ThemeProvider'
import { useRouter } from 'expo-router'
import _ from 'lodash'
import { LogBox } from 'react-native'
import { Feather } from '@expo/vector-icons';

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
type Costumes = {
  id: number
  display_name: string
  title: string
  price: number
  description: string
  created_at: string
  hilight: boolean
  location: string
  costume_images?: {
    image_url: string
  }[]
};

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
const formatDate = (dateString: string) => {
  try {
    const utcDate = parseISO(dateString) // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà UTC
    const bangkokDate = toZonedTime(utcDate, 'Asia/Bangkok') // ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡πÑ‡∏ó‡∏¢
    const relativeTime = formatDistanceToNow(bangkokDate, { 
      addSuffix: true,
      locale: th 
    })
    return relativeTime
  } catch (error) {
    console.error('Error formatting date:', error) // ‡∏Å‡∏£‡∏ì‡∏µ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
    return dateString // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
  }
}

export default function Home() {
  const { session } = useAuth() // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
  const [products, setProducts] = useState<Costumes[]>([]) // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
  const [costumes, setCostumes] = useState<Costumes[]>([])
  const [hilightProducts, setHilightProducts] = useState<Costumes[]>([]) // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  const [filteredProducts, setFilteredProducts] = useState<Costumes[]>([]) // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏á
  const [searchQuery, setSearchQuery] = useState("") // ‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const [refreshing, setRefreshing] = useState(false) // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
  const { theme } = useTheme() // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏ò‡∏µ‡∏°
  const router = useRouter() // ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤

  const supabaseUrl = process.env.EXPO_PUBLIC_SUPABASE_URL
  const supabaseAnonKey = process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY

  if (!supabaseUrl || !supabaseAnonKey) {
    throw new Error("Missing Supabase environment variables") // ‡∏Å‡∏£‡∏ì‡∏µ‡∏Ç‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Supabase
  } 

  // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ pagination
  const [page, setPage] = useState(0) // ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
  const [isLoadingMore, setIsLoadingMore] = useState(false) // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°
  const [hasMore, setHasMore] = useState(true) // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const ITEMS_PER_PAGE = 3 // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const [isSearching, setIsSearching] = useState(false)

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö URL ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
  const [avatarUrl, setAvatarUrl] = useState<string | null>(null)
  const [displayName, setDisplayName] = useState("")

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå
  const fetchProfile = async () => {
    try {
      if (!session?.user?.id) return
  
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name, avatar_url')
        .eq('id', session.user.id)
        .single()
  
      if (error) throw error
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ displayName
      if (data?.display_name) {
        setDisplayName(data.display_name);
      }
      
      if (data?.avatar_url) {
        setAvatarUrl(data.avatar_url)
      }
    } catch (error) {
      console.error('Error fetching profile:', error)
    }
  }

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ session ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  useEffect(() => {
    if (session?.user) {
      fetchProfile();
    }
  }, [session]);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Supabase
  const searchProducts = async (searchText: string) => {
    try {
      setIsSearching(true)
      
      const { data, error, count } = await supabase
        .from('costumes')
        .select(`
          *,
          costumes (
            image_url
          )
        `, { count: 'exact' })
        .ilike('title', `%${searchText}%`)
        .range(0, ITEMS_PER_PAGE - 1)
        .order('created_at', { ascending: false })

      if (error) throw error

      setFilteredProducts(data || [])
      setHasMore(count ? count > ITEMS_PER_PAGE : false)
      setPage(0)
      
    } catch (error) {
      console.error('üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î:', error)
    } finally {
      setIsSearching(false)
    }
  }

  // ‡πÉ‡∏ä‡πâ debounce ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ
  const debouncedSearch = _.debounce((text: string) => {
    searchProducts(text)
  }, 500)

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
  const handleSearch = (text: string) => {
    setSearchQuery(text)
    
    if (text.trim() === "") {
      setFilteredProducts(products) // ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
      setHasMore(true) // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
      setPage(0) // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
      return
    }

    debouncedSearch(text)
  }

  // ‡∏ü‡∏±‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  const fetchHilightProducts = async () => {
    try {
      const { data, error } = await supabase
        .from('costumes')
        .select(`
          *,
          costume_images (
            image_url
          )
        `)
        .eq('hilight', true)
        .order('created_at', { ascending: false })

      if (error) throw error
      setHilightProducts(data || []) // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
    } catch (error) {
      console.error("Error fetching hilight products:", error)
    }
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ pagination
  const fetchProducts = async (pageNumber = 0) => {
    try {
      const from = pageNumber * ITEMS_PER_PAGE
      console.log('üîç ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πâ‡∏≤:', {
        page: pageNumber,
        from,
        to: from + ITEMS_PER_PAGE - 1
      })
      
      const { count } = await supabase
        .from('costumes')
        .select('*', { count: 'exact', head: true })

      console.log('üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:', count)

      if (count && from >= count) {
        console.log('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°')
        setHasMore(false)
        return
      }

      const to = from + ITEMS_PER_PAGE - 1

      const { data, error } = await supabase
        .from('costumes')
        .select(`
          *,
          costume_images (
            image_url
          )
        `)
        .range(from, to)
        .order('created_at', { ascending: false })

      if (error) throw error

      setHasMore(count ? from + ITEMS_PER_PAGE < count : false)

      if (pageNumber === 0) {
        setProducts(data || []) // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      } else {
        setProducts(prev => [...prev, ...(data || [])])
      }
    } catch (error) {
      console.error("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:", error)
      setHasMore(false)
    }
  }

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î
const fetchCostumes = async () => {
  try {
    const { data, error } = await supabase
      .from('costumes') // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á costumes ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
      .select(`
        *,
        costume_images (
          image_url
        )
      `)
      .order('created_at', { ascending: false })

    if (error) throw error
    setCostumes(data || [])
  } catch (error) {
    console.error("Error fetching costumes:", error)
  }
}

// ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô onRefresh ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢
const onRefresh = async () => {
  setRefreshing(true)
  setPage(0)
  setHasMore(true)
  await Promise.all([
    fetchProducts(0),
    fetchHilightProducts(),
    fetchCostumes() // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏î
  ])
  setRefreshing(false)
}

// ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ initializeProducts ‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
useEffect(() => {
  const initializeProducts = async () => {
    setRefreshing(true);
    await Promise.all([
      fetchProducts(0),
      fetchHilightProducts(),
      fetchCostumes()
    ]);
    setRefreshing(false);
  };

  initializeProducts();
}, []);

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
  const handleHorizontalCardPress = (product: Costumes) => {
    router.push({
      pathname: '/productdetail',
      params: {
        id: product.id,
        title: product.title,
        price: product.price,
        description: product.description,
        image: product.costume_images?.[0]?.image_url,
        created_at: product.created_at,
        location: product.location
      }
    })
  }

  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  const handleProductCardPress = (product: Costumes) => {
    router.push({
      pathname: '/productdetail',
      params: {
        id: product.id,
        title: product.title,
        price: product.price,
        description: product.description,
        image: product.costume_images?.[0]?.image_url,
        created_at: product.created_at,
        location: product.location
      }
    })
  }

  useEffect(() => {
    const initializeProducts = async () => {
      setRefreshing(true); // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
      await Promise.all([
        fetchProducts(0), // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
        fetchHilightProducts()
      ]);
      setRefreshing(false); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
    };

    initializeProducts(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  }, []);

  LogBox.ignoreAllLogs();

  return (
    <SafeAreaView className="h-full">
      <View className="h-full">
        <FlatList
          ListHeaderComponent={() => (
            <View className="flex py-6 space-y-6">
              {/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå */}
              <View className="flex justify-between items-start flex-row mb-6 px-4">
                <View>
                  <Text className="font-pmedium text-md text-gray-100">
                    ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö
                  </Text>
                  <Text className="text-2xl text-white">
                    {displayName || '‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}
                  </Text>
                </View>
                <View className="mt-1.5">
                  <TouchableOpacity onPress={() => router.push('/(tabs)/profile')}>
                    <Image
                      source={{ 
                        uri: avatarUrl || 'https://upload.wikimedia.org/wikipedia/commons/8/89/Portrait_Placeholder.png',
                        cache: 'reload'
                      }}
                      className="w-10 h-10 rounded-full"
                      onError={(e) => {
                        console.error('Image loading error:', e.nativeEvent.error)
                        setAvatarUrl(null)
                      }}
                    />
                  </TouchableOpacity>
                </View>
              </View>
  
              {/* ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ */}
              <SearchInput 
                initialQuery={searchQuery} 
                onChangeText={handleSearch}
                placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
              />
  
              {isSearching && (
                <View className="py-2 items-center">
                  <ActivityIndicator size="small" color="#0284c7" />
                  <Text className="text-gray-500 mt-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...</Text>
                </View>
              )}
  
              {!searchQuery.trim() && (
                <>
                  {/* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ */}
                  <View className="w-full flex-1 pt-5 px-4">
                    <Text className="text-lg font-pregular text-gray-100">
                      ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                    </Text>
                  </View>
                  <FlatList
                    horizontal
                    data={hilightProducts}
                    keyExtractor={(item) => `hilight_${item.id}`}
                    renderItem={({ item }) => (
                      <HorizontalCard
                        image={item.costume_images?.[0]?.image_url || 'https://upload.wikimedia.org/wikipedia/commons/1/14/No_Image_Available.jpg'}
                        title={item.title}
                        onPress={() => handleHorizontalCardPress(item)}
                      />
                    )}
                    showsHorizontalScrollIndicator={false}
                    className="mt-4"
                    ListEmptyComponent={() => (
                      <View className="px-4">
                        <Text className="text-gray-500">
                          ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
                        </Text>
                      </View>
                    )}
                  />
  
                  {/* ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πà‡∏≤ */}
                  <View className="w-full flex-1 pt-5 px-4 mt-4">
                    <Text className="text-lg font-pregular text-gray-100">
                      ‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πà‡∏≤
                    </Text>
                  </View>
                  <FlatList
                    horizontal
                    data={costumes}
                    keyExtractor={(item) => `costume_${item.id}`}
                    renderItem={({ item }) => (
                      <HorizontalCard
                        image={item.costume_images?.[0]?.image_url || 'https://upload.wikimedia.org/wikipedia/commons/1/14/No_Image_Available.jpg'}
                        title={item.title}
                        onPress={() => handleHorizontalCardPress(item)}
                      />
                    )}
                    showsHorizontalScrollIndicator={false}
                    className="mt-4"
                    ListEmptyComponent={() => (
                      <View className="px-4">
                        <Text className="text-gray-500">
                          ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡πà‡∏≤
                        </Text>
                      </View>
                    )}
                  />
                </>
              )}
            </View>
          )}
          /* ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î FlatList */
          ItemSeparatorComponent={() => (
            <View 
              className={`h-[1px] mx-8 ${
                theme === 'dark' ? 'bg-gray-200' : 'bg-gray-200'
              }`}
            />
          )}
          data={filteredProducts}
          keyExtractor={(item) => `product_${item.id}`}
          renderItem={({ item }) => (
            <ProductCard
              productname={item.title}
              productprice={`‡∏ø${item.price.toLocaleString()}`}
              productimage={item.costume_images?.[0]?.image_url || 'https://upload.wikimedia.org/wikipedia/commons/1/14/No_Image_Available.jpg'}
              postDate={formatDate(item.created_at)}
              description={item.description}
              onPress={() => handleProductCardPress(item)}
            />
          )}
          ListEmptyComponent={() => (
            <View className="p-4">
              <Text className="text-center">
                {searchQuery.trim() ? '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}
              </Text>
            </View>
          )}
          
          onEndReachedThreshold={0.5}
          refreshControl={
            <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
          }
          ListFooterComponent={() => (
            isLoadingMore ? (
              <View className="py-4">
                <ActivityIndicator size="small" />
              </View>
            ) : null
          )}
        />
        <TouchableOpacity
          style={{
            position: 'absolute',
            bottom: 25,
            right: 25,
            width: 60,
            height: 60,
            borderRadius: 30,
            backgroundColor: '#FFA7D1',
            justifyContent: 'center',
            alignItems: 'center',
            shadowColor: '#000',
            shadowOffset: { width: 0, height: 2 },
            shadowOpacity: 0.3,
            shadowRadius: 4,
            elevation: 5,
          }}
          onPress={() => router.push('/addcostume')}
        >
          <Feather name="plus" size={24} color="#FFF" />
        </TouchableOpacity>
      </View>
    </SafeAreaView>
  );
}
